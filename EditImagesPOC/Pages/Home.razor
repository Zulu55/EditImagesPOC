@page "/"

<PageTitle>Edit Images POC</PageTitle>
<h1>Edit Images POC</h1>

<InputFile OnChange="OnImageSelected" accept="image/*" />

<div>
    <canvas id="imageCanvas" width="400" height="300"
            style="border:1px solid #ccc; cursor: crosshair;"
            @onclick="OnCanvasClick"></canvas>
</div>

<br />

<button class="btn btn-primary mt-2" @onclick="ShowInput">Add Text</button>
<button class="btn btn-warning mt-2" @onclick="StartRectangle">Rectangle</button>
<button class="btn btn-success mt-2" @onclick="StartCircle">Circle</button>
<button class="btn btn-danger mt-2" @onclick="ClearCanvas">Clean</button>

@if (ShowTextInput)
{
    <div style="margin-top: 10px;">
        <input @bind="InputText" placeholder="Enter text..." />
        <button class="btn btn-success" @onclick="AddText">OK</button>
        <button class="btn btn-danger" @onclick="Cancel">Cancel</button>
    </div>
}

@code {
    private bool ShowTextInput = false;
    private string InputText = string.Empty;
    private double ClickX;
    private double ClickY;
    private bool AwaitingTextPosition = false;

    private bool DrawingRectangle = false;
    private double RectStartX, RectStartY;
    private bool RectFirstClick = true;

    private bool DrawingCircle = false;
    private double CircleCenterX, CircleCenterY;
    private bool CircleFirstClick = true;

    [Inject] IJSRuntime JS { get; set; } = null!;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("drawImageOnCanvas", "images/truck.jpg");
        }
    }

    private async Task OnImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB max
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var bytes = ms.ToArray();
            var base64 = Convert.ToBase64String(bytes);
            var imageDataUrl = $"data:{file.ContentType};base64,{base64}";
            await JS.InvokeVoidAsync("drawImageOnCanvas", imageDataUrl);
        }
    }


    private async Task ClearCanvas()
    {
        await JS.InvokeVoidAsync("drawImageOnCanvas", "images/truck.jpg");
    }

    private void ShowInput()
    {
        AwaitingTextPosition = true;
        ShowTextInput = false;
        InputText = string.Empty;
        DrawingRectangle = false;
    }

    private async void OnCanvasClick(MouseEventArgs e)
    {
        if (AwaitingTextPosition)
        {
            ClickX = e.OffsetX;
            ClickY = e.OffsetY;
            ShowTextInput = true;
            AwaitingTextPosition = false;
            StateHasChanged();
        }
        else if (DrawingRectangle)
        {
            if (RectFirstClick)
            {
                RectStartX = e.OffsetX;
                RectStartY = e.OffsetY;
                RectFirstClick = false;
            }
            else
            {
                double rectEndX = e.OffsetX;
                double rectEndY = e.OffsetY;
                double x = Math.Min(RectStartX, rectEndX);
                double y = Math.Min(RectStartY, rectEndY);
                double width = Math.Abs(rectEndX - RectStartX);
                double height = Math.Abs(rectEndY - RectStartY);

                await JS.InvokeVoidAsync("drawRectangleOnCanvas", x, y, width, height);
                DrawingRectangle = false;
                RectFirstClick = true;
            }
        }
        else if (DrawingCircle)
        {
            if (CircleFirstClick)
            {
                CircleCenterX = e.OffsetX;
                CircleCenterY = e.OffsetY;
                CircleFirstClick = false;
            }
            else
            {
                double dx = e.OffsetX - CircleCenterX;
                double dy = e.OffsetY - CircleCenterY;
                double radius = Math.Sqrt(dx * dx + dy * dy);

                await JS.InvokeVoidAsync("drawCircleOnCanvas", CircleCenterX, CircleCenterY, radius);
                DrawingCircle = false;
                CircleFirstClick = true;
            }
        }
    }

    private async Task AddText()
    {
        await JS.InvokeVoidAsync("drawTextOnCanvas", InputText, ClickX, ClickY);
        ShowTextInput = false;
        InputText = string.Empty;
    }

    private void Cancel()
    {
        ShowTextInput = false;
        InputText = string.Empty;
    }

    private void StartRectangle()
    {
        DrawingRectangle = true;
        RectFirstClick = true;
        AwaitingTextPosition = false;
        ShowTextInput = false;
    }

    private void StartCircle()
    {
        DrawingCircle = true;
        CircleFirstClick = true;
        DrawingRectangle = false;
        AwaitingTextPosition = false;
        ShowTextInput = false;
    }
}
